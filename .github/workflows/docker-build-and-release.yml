name: Build Docker Image and Release (Fixed Newline Issue)

on:
  push:
    tags:
      - '*'

permissions:
  contents: write

jobs:
  build-and-release-split:
    runs-on: ubuntu-latest
    steps:
      - name: Free up Runner disk space
        run: |
          echo "===== 清理前磁盘使用 ====="
          df -h
          sudo rm -rf /usr/local/lib/android /opt/ghc /usr/share/dotnet /opt/hostedtoolcache/*
          docker system prune -a -f --volumes
          sudo apt-get clean && sudo apt-get autoremove -y
          echo "===== 清理后磁盘使用 ====="
          df -h

      - name: Checkout code (shallow clone)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set environment variables
        id: set_vars
        run: |
          TAG_NAME=$(basename "${GITHUB_REF}")
          IMAGE_NAME=$(echo "${TAG_NAME}" | tr -cd 'a-zA-Z0-9_-')
          # 绝对路径分卷前缀（避免路径问题）
          SPLIT_PREFIX="${GITHUB_WORKSPACE}/${IMAGE_NAME}.tar.gz"
          
          echo "===== 生成的变量值 ====="
          echo "TAG_NAME: ${TAG_NAME}"
          echo "IMAGE_NAME: ${IMAGE_NAME}"
          echo "SPLIT_PREFIX: ${SPLIT_PREFIX}"
          
          # 写入ENV
          echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_ENV
          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV
          echo "SPLIT_PREFIX=${SPLIT_PREFIX}" >> $GITHUB_ENV
          # 导出step输出（无换行）
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "split_prefix=${SPLIT_PREFIX}" >> $GITHUB_OUTPUT

      - name: Build Docker image
        run: |
          echo "===== 构建镜像：${{ env.IMAGE_NAME }} ====="
          docker build --no-cache --compress -t ${{ env.IMAGE_NAME }}:latest .
          if ! docker images | grep ${{ env.IMAGE_NAME }}; then
            echo "ERROR: 镜像构建失败"
            exit 1
          fi

      - name: Save, compress and split image (fix newline)
        id: split_step
        run: |
          echo "===== 开始分卷处理 ====="
          # 管道流分卷（无中间大文件）
          docker save ${{ env.IMAGE_NAME }}:latest | gzip | split -b 1900M - ${{ env.SPLIT_PREFIX }}. --numeric-suffixes=1 --suffix-length=3
          
          # 核心修复：将分卷文件列表转为【空格分隔的单行字符串】（避免换行符）
          # ls -1 列出文件（每行一个）→ tr '\n' ' ' 替换换行为空格 → xargs 去除末尾多余空格
          SPLIT_FILES=$(ls -1 ${{ env.SPLIT_PREFIX }}.* 2>/dev/null | tr '\n' ' ' | xargs)
          
          # 强制检查分卷文件是否生成
          if [ -z "$SPLIT_FILES" ]; then
            echo "ERROR: 分卷文件未生成！"
            exit 1
          fi
          
          # 统计分卷数量（用wc -w统计空格分隔的文件数）
          SPLIT_COUNT=$(echo "$SPLIT_FILES" | wc -w)
          
          echo "===== 分卷结果 ====="
          echo "分卷数量：${SPLIT_COUNT}"
          echo "分卷文件（单行）：${SPLIT_FILES}" # 验证是单行无换行
          
          # 写入ENV（单行字符串，无换行）
          echo "SPLIT_COUNT=${SPLIT_COUNT}" >> $GITHUB_ENV
          echo "SPLIT_FILES=${SPLIT_FILES}" >> $GITHUB_ENV
          # 导出step输出（单行字符串，无换行）
          echo "split_count=${SPLIT_COUNT}" >> $GITHUB_OUTPUT
          echo "split_files=${SPLIT_FILES}" >> $GITHUB_OUTPUT

      - name: Create Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.set_vars.outputs.tag_name }}
          body: |
            ## Docker镜像发布（${{ steps.set_vars.outputs.tag_name }}）
            ### 镜像信息
            - 镜像名：${{ steps.set_vars.outputs.image_name }}:latest
            - 分卷数量：${{ steps.split_step.outputs.split_count }} 个
            - 单卷大小：最大1900MB（避免GitHub 2GB限制）
            
            ### 使用步骤
            1. 下载所有分卷文件到同一目录
            2. 合并分卷并解压（复制以下命令执行）：
               ```bash
               cat ${{ steps.set_vars.outputs.split_prefix }}.* | gzip -d > ${{ steps.set_vars.outputs.image_name }}.tar
