name: Build Docker Image and Release (Split Compress + Storage Optimize)

on:
  push:
    tags:
      - '*'

permissions:
  contents: write

jobs:
  build-and-release-split:
    runs-on: ubuntu-latest
    steps:
      ###########################################################################
      # 步骤0：紧急清理Runner冗余文件（优先释放空间，核心优化）
      ###########################################################################
      - name: Free up Runner disk space
        run: |
          echo "===== 清理前磁盘使用情况 ====="
          df -h
          
          # 1. 删除预安装的大型工具/镜像（GitHub Runner默认预装，非必需）
          sudo rm -rf /usr/local/lib/android  # 安卓SDK（约10GB）
          sudo rm -rf /opt/ghc                # Haskell编译器（约2GB）
          sudo rm -rf /usr/share/dotnet       # .NET SDK（约2GB）
          sudo rm -rf /opt/hostedtoolcache/*  # 缓存的工具链（如Python/Node版本）
          
          # 2. 删除Docker旧镜像/缓存（释放容器存储）
          docker system prune -a -f --volumes
          
          # 3. 清理APT缓存
          sudo apt-get clean
          sudo apt-get autoremove -y
          
          echo "===== 清理后磁盘使用情况 ====="
          df -h

      ###########################################################################
      # 步骤1：检出仓库代码（浅克隆，减少代码体积）
      ###########################################################################
      - name: Checkout code (shallow clone)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # 浅克隆，只拉取最新提交，不下载完整历史

      ###########################################################################
      # 步骤2：设置环境变量
      ###########################################################################
      - name: Set environment variables
        id: set_vars
        run: |
          TAG_NAME=$(basename "${GITHUB_REF}")
          IMAGE_NAME=$(echo "${TAG_NAME}" | tr -cd 'a-zA-Z0-9_-')
          SPLIT_PREFIX="${IMAGE_NAME}.tar.gz"
          
          echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_ENV
          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV
          echo "SPLIT_PREFIX=${SPLIT_PREFIX}" >> $GITHUB_ENV
          echo "===== 环境变量 ====="
          echo "TAG_NAME: ${TAG_NAME}"
          echo "IMAGE_NAME: ${IMAGE_NAME}"

      ###########################################################################
      # 步骤3：构建Docker镜像（优化构建缓存，减少临时文件）
      ###########################################################################
      - name: Build Docker image (optimize cache)
        run: |
          echo "===== 构建Docker镜像 ====="
          # 构建时禁用缓存，减少临时文件；同时压缩镜像层
          docker build --no-cache --compress -t ${IMAGE_NAME}:latest .
          docker images | grep ${IMAGE_NAME}

      ###########################################################################
      # 步骤4：边保存边压缩+分卷（核心：不生成完整大tar包，节省空间）
      ###########################################################################
      - name: Save, compress and split Docker image (no full tar)
        run: |
          echo "===== 开始镜像导出+压缩+分卷 ====="
          # 核心优化：docker save → gzip压缩 → split分卷（一步到位，无中间大文件）
          docker save ${IMAGE_NAME}:latest | gzip | split -b 1900M - ${SPLIT_PREFIX}. --numeric-suffixes=1 --suffix-length=3
          
          echo "===== 验证分卷文件 ====="
          ls -lh ${SPLIT_PREFIX}.*
          
          # 统计分卷数量
          SPLIT_COUNT=$(ls -1 ${SPLIT_PREFIX}.* | wc -l)
          echo "SPLIT_COUNT=${SPLIT_COUNT}" >> $GITHUB_ENV
          SPLIT_FILES=$(ls -1 ${SPLIT_PREFIX}.* | tr '\n' ' ')
          echo "SPLIT_FILES=${SPLIT_FILES}" >> $GITHUB_ENV

      ###########################################################################
      # 步骤5：创建Release并上传分卷
      ###########################################################################
      - name: Create Release and upload split assets
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${TAG_NAME}
          body: |
            ## Docker镜像发布（${TAG_NAME}）
            ### 镜像信息
            - 镜像名：${IMAGE_NAME}:latest
            - 分卷数量：${SPLIT_COUNT} 个
            - 单卷大小：最大1900MB
            
            ### 使用步骤
            1. 下载所有分卷文件到同一目录
            2. 合并分卷并解压：
               ```bash
               cat ${SPLIT_PREFIX}.* | gzip -d > ${IMAGE_NAME}.tar
