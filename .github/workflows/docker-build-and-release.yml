name: Build Docker Image and Release (Final Fix - Assets Upload)
on:
  push:
    tags:
      - '*'
permissions:
  contents: write
jobs:
  build-release-split:
    runs-on: ubuntu-latest
    steps:
      - name: Free up Runner disk space
        run: |
          echo "===== 清理前磁盘使用情况 ====="
          df -h
          sudo rm -rf /usr/local/lib/android /opt/ghc /usr/share/dotnet /opt/hostedtoolcache/*
          docker system prune -a -f --volumes
          sudo apt-get clean && sudo apt-get autoremove -y
          echo "===== 清理后磁盘使用情况 ====="
          df -h
      - name: Checkout code (shallow clone)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Set environment variables
        id: set_vars
        run: |
          TAG_NAME=$(basename "${GITHUB_REF}")
          IMAGE_NAME=$(echo "${TAG_NAME}" | tr -cd 'a-zA-Z0-9_-')
          SPLIT_PREFIX="${IMAGE_NAME}.tar.gz"
          echo "===== 环境变量验证 ====="
          echo "TAG_NAME: ${TAG_NAME}"
          echo "IMAGE_NAME: ${IMAGE_NAME}"
          echo "SPLIT_PREFIX: ${SPLIT_PREFIX}"
          echo "Runner工作目录: ${GITHUB_WORKSPACE}"
          echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_ENV
          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV
          echo "SPLIT_PREFIX=${SPLIT_PREFIX}" >> $GITHUB_ENV
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "split_prefix=${SPLIT_PREFIX}" >> $GITHUB_OUTPUT
      - name: Build Docker image
        run: |
          echo "===== 开始构建Docker镜像 ====="
          docker build --no-cache --compress -t ${{ env.IMAGE_NAME }}:latest .
          if ! docker images | grep -q "${{ env.IMAGE_NAME }}"; then
            echo "ERROR: Docker镜像构建失败！"
            exit 1
          fi
          echo "===== 镜像构建成功 ====="
          docker images | grep "${{ env.IMAGE_NAME }}"
      - name: Save & split Docker image (relative path)
        id: split_step
        run: |
          echo "===== 开始镜像导出+分卷压缩 ====="
          docker save ${{ env.IMAGE_NAME }}:latest | gzip | split -b 1900M - ${{ env.SPLIT_PREFIX }}. --numeric-suffixes=1 --suffix-length=3
          if ! ls -1 ${{ env.SPLIT_PREFIX }}.* 2>/dev/null; then
            echo "ERROR: 分卷文件未生成！"
            exit 1
          fi
          SPLIT_COUNT=$(ls -1 ${{ env.SPLIT_PREFIX }}.* | wc -l)
          echo "===== 分卷结果验证 ====="
          echo "分卷数量：${SPLIT_COUNT}"
          echo "分卷文件列表（相对路径）："
          ls -lh ${{ env.SPLIT_PREFIX }}.*
          echo "split_count=${SPLIT_COUNT}" >> $GITHUB_OUTPUT
      - name: Create Release & upload split assets
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.set_vars.outputs.tag_name }}
          body: |
            ## Docker镜像发布（${{ steps.set_vars.outputs.tag_name }}）
            ### 镜像信息
            - 镜像名：${{ steps.set_vars.outputs.image_name }}:latest
            - 分卷数量：${{ steps.split_step.outputs.split_count }} 个
            - 单卷大小：最大1900MB（规避GitHub 2GB限制）
            
            ### 使用步骤
            1. 下载所有分卷文件到本地同一目录
            2. 合并分卷并解压为镜像包：
               ```bash
               cat ${{ steps.set_vars.outputs.split_prefix }}.* | gzip -d > ${{ steps.set_vars.outputs.image_name }}.tar
               ```
            3. 导入Docker镜像：
               ```bash
               docker load < ${{ steps.set_vars.outputs.image_name }}.tar
               ```
            4. 验证镜像：
               ```bash
               docker images | grep ${{ steps.set_vars.outputs.image_name }}
               ```
          files: ${{ env.SPLIT_PREFIX }}.*
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Cleanup temporary files
        if: always()
        run: |
          echo "===== 开始清理临时文件 ====="
          rm -rf ${{ env.SPLIT_PREFIX }}.*
          docker rmi -f ${{ env.IMAGE_NAME }}:latest
          docker system prune -a -f --volumes
          echo "===== 清理完成 ====="
          df -h
